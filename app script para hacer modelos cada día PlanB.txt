// ============================================================
//   AUTOMATIZACI√ìN DE COLAB - VERSI√ìN FINAL
//   Ejecuta notebook de domingo a jueves a las 21:00
// ============================================================

// ‚úÖ CONFIGURACI√ìN (YA EST√Å CON TUS DATOS)
const CONFIG = {
  NOTEBOOK_ID: '1Fo5nubg6LSKVjhvp1MTse4cybmDlesIs',
  EMAIL: 'jsgaston82@gmail.com',
  EXECUTION_HOUR: 21,
  GPU_TYPE: 'T4',
  MAX_EXECUTION_TIME: 15,
  
  // üì± MENSAJER√çA (Elige la que quieras activar)
  USAR_TELEGRAM: true,        // ‚≠ê RECOMENDADO: R√°pido y gratis
  USAR_WHATSAPP: false,        // Via Twilio (requiere cuenta)
  USAR_SLACK: false,           // Si usas Slack
  USAR_DISCORD: false,         // Si usas Discord
  USAR_PUSHBULLET: false,      // Notificaciones m√≥vil
  
  // üîë Tokens (solo los que uses)
  TELEGRAM_BOT_TOKEN: '8502620685:AAGnHy3x5iC5ACP91hYEnJ-yrl4_7oUUAdk',
  TELEGRAM_CHAT_ID: '5825443798',
  
  TWILIO_ACCOUNT_SID: '',
  TWILIO_AUTH_TOKEN: '',
  TWILIO_WHATSAPP_FROM: '',
  TWILIO_WHATSAPP_TO: '',
  
  SLACK_WEBHOOK_URL: '',
  DISCORD_WEBHOOK_URL: '',
  PUSHBULLET_API_KEY: ''
};

// ============================================================
//   FUNCI√ìN PRINCIPAL
// ============================================================

function ejecutarNotebookDiario() {
  const startTime = new Date();
  Logger.log('üöÄ Iniciando ejecuci√≥n autom√°tica: ' + startTime);
  
  try {
    // 1. Verificar si es d√≠a de ejecuci√≥n (Domingo a Jueves)
    if (!esHorarioEjecucion()) {
      Logger.log('‚è∏Ô∏è No es horario de ejecuci√≥n');
      return;
    }
    
    // 2. Preparar notebook
    Logger.log('üìù Preparando notebook...');
    const notebookContent = obtenerNotebook();
    
    // 3. Modificar notebook para auto-ejecuci√≥n
    const notebookModificado = prepararAutoEjecucion(notebookContent);
    
    // 4. Guardar versi√≥n temporal
    const tempNotebookId = guardarNotebookTemporal(notebookModificado);
    
    // 5. Ejecutar en Colab
    Logger.log('‚ö° Ejecutando notebook en Colab...');
    const resultado = ejecutarEnColab(tempNotebookId);
    
    // 6. Monitorear ejecuci√≥n
    const exito = monitorearEjecucion(tempNotebookId);
    
    // 7. Limpiar temporales
    limpiarTemporales(tempNotebookId);
    
    // 8. Enviar notificaci√≥n
    const duracion = (new Date() - startTime) / 60000;
    enviarNotificacion(exito, duracion);
    
    Logger.log('‚úÖ Ejecuci√≥n completada');
    
  } catch (error) {
    Logger.log('‚ùå Error: ' + error);
    enviarNotificacionError(error);
  }
}

// ============================================================
//   VERIFICACI√ìN DE HORARIO (DOMINGO A JUEVES)
// ============================================================

function esHorarioEjecucion() {
  const ahora = new Date();
  const diaSemana = ahora.getDay();
  const hora = ahora.getHours();
  
  // D√≠as Forex: Domingo=0, Lunes=1, Martes=2, Mi√©rcoles=3, Jueves=4
  const diasForex = [0, 1, 2, 3, 4];
  
  if (diasForex.includes(diaSemana) && hora === CONFIG.EXECUTION_HOUR) {
    Logger.log(`‚úÖ Es d√≠a Forex: ${obtenerNombreDia(diaSemana)} a las ${hora}:00`);
    return true;
  }
  
  Logger.log(`‚è∏Ô∏è NO es d√≠a Forex: ${obtenerNombreDia(diaSemana)} - Mercado cerrado`);
  return false;
}

function obtenerNombreDia(dia) {
  const nombres = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
  return nombres[dia];
}

// ============================================================
//   FUNCIONES DE NOTEBOOK
// ============================================================

function obtenerNotebook() {
  try {
    const file = DriveApp.getFileById(CONFIG.NOTEBOOK_ID);
    const content = file.getBlob().getDataAsString();
    return JSON.parse(content);
  } catch (error) {
    throw new Error('No se pudo obtener notebook: ' + error);
  }
}

function prepararAutoEjecucion(notebook) {
  const modified = JSON.parse(JSON.stringify(notebook));
  
  modified.cells.forEach((cell) => {
    if (cell.cell_type === 'code' && cell.source) {
      const source = cell.source.join('');
      
      if (source.includes("input(")) {
        cell.source = [
          "# AUTO-EJECUCI√ìN: Respuesta autom√°tica\n",
          "user_choice = 's'\n",
          "print('‚úÖ Modo autom√°tico: Ejecutando con TF2ONNX')\n"
        ];
      }
    }
  });
  
  return modified;
}

function guardarNotebookTemporal(notebook) {
  const timestamp = new Date().getTime();
  const fileName = `temp_auto_execution_${timestamp}.ipynb`;
  
  const folder = DriveApp.getFolderById(
    DriveApp.getFileById(CONFIG.NOTEBOOK_ID).getParents().next().getId()
  );
  
  const blob = Utilities.newBlob(
    JSON.stringify(notebook, null, 2),
    'application/x-ipynb+json',
    fileName
  );
  
  const file = folder.createFile(blob);
  Logger.log('üìÑ Notebook temporal creado: ' + file.getId());
  
  return file.getId();
}

function ejecutarEnColab(notebookId) {
  const colabUrl = `https://colab.research.google.com/drive/${notebookId}`;
  Logger.log('üîó URL de Colab: ' + colabUrl);
  
  return {
    url: colabUrl,
    notebookId: notebookId,
    timestamp: new Date()
  };
}

// ============================================================
//   MONITOREO
// ============================================================

function monitorearEjecucion(notebookId) {
  const maxIntentos = CONFIG.MAX_EXECUTION_TIME * 2;
  let intentos = 0;
  
  Logger.log('üëÄ Monitoreando ejecuci√≥n...');
  
  while (intentos < maxIntentos) {
    Utilities.sleep(30000);
    
    const estado = verificarEstadoNotebook(notebookId);
    
    if (estado.completado) {
      Logger.log('‚úÖ Ejecuci√≥n completada exitosamente');
      return true;
    }
    
    if (estado.error) {
      Logger.log('‚ùå Error en ejecuci√≥n');
      return false;
    }
    
    intentos++;
    Logger.log(`‚è≥ Progreso: ${intentos}/${maxIntentos}`);
  }
  
  Logger.log('‚è∞ Timeout alcanzado');
  return false;
}

function verificarEstadoNotebook(notebookId) {
  try {
    const file = DriveApp.getFileById(notebookId);
    const ultimaModificacion = file.getLastUpdated();
    const ahora = new Date();
    const diferencia = (ahora - ultimaModificacion) / 60000;
    
    if (diferencia < 2) {
      return { completado: false, error: false };
    }
    
    const folder = file.getParents().next();
    const archivos = folder.getFilesByName('training_results.png');
    
    if (archivos.hasNext()) {
      const archivoResultado = archivos.next();
      const fechaResultado = archivoResultado.getLastUpdated();
      
      if ((ahora - fechaResultado) / 60000 < 30) {
        return { completado: true, error: false };
      }
    }
    
    return { completado: false, error: false };
    
  } catch (error) {
    return { completado: false, error: true };
  }
}

// ============================================================
//   LIMPIEZA
// ============================================================

function limpiarTemporales(notebookId) {
  try {
    const file = DriveApp.getFileById(notebookId);
    file.setTrashed(true);
    Logger.log('üóëÔ∏è Archivos temporales eliminados');
  } catch (error) {
    Logger.log('‚ö†Ô∏è No se pudieron eliminar temporales: ' + error);
  }
}

// ============================================================
//   NOTIFICACIONES MEJORADAS CON M√öLTIPLES PLATAFORMAS
// ============================================================

function enviarNotificacion(exito, duracion) {
  const fecha = new Date().toLocaleString('es-ES', { 
    timeZone: 'Europe/Madrid',
    weekday: 'long',
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
  
  const emoji = exito ? '‚úÖ' : '‚ö†Ô∏è';
  const estado = exito ? '√âXITO' : 'ADVERTENCIA';
  
  // Mensaje corto para Telegram/WhatsApp
  const mensajeCorto = `${emoji} *Colab Forex LSTM*

üìä Resultado: ${estado}
‚è±Ô∏è Duraci√≥n: ${duracion.toFixed(1)} min
üìÖ ${fecha}

‚úÖ Archivos actualizados
üîó Drive: drive.google.com`;
  
  // Mensaje largo para Email
  const mensajeEmail = `
Ejecuci√≥n autom√°tica de Colab - FOREX LSTM

üìä Resultado: ${estado}
‚è±Ô∏è Duraci√≥n: ${duracion.toFixed(2)} minutos
üìÖ Fecha: ${fecha}

üìÅ Archivos generados:
- eurusd_lstm_pytorch.onnx
- eurusd_lstm_tf2onnx.onnx
- training_results.png
- EURUSD_1h_data.csv (actualizado)

üîó Ver en Drive: https://drive.google.com/drive/my-drive

---
Automatizaci√≥n via Google Apps Script
  `;
  
  const asunto = `${emoji} Colab ejecutado ${exito ? 'exitosamente' : 'con advertencias'}`;
  
  // Enviar a todas las plataformas activadas
  if (CONFIG.USAR_TELEGRAM) {
    enviarTelegram(mensajeCorto);
  }
  
  if (CONFIG.USAR_WHATSAPP) {
    enviarWhatsApp(mensajeCorto);
  }
  
  if (CONFIG.USAR_SLACK) {
    enviarSlack(mensajeCorto);
  }
  
  if (CONFIG.USAR_DISCORD) {
    enviarDiscord(mensajeCorto);
  }
  
  if (CONFIG.USAR_PUSHBULLET) {
    enviarPushbullet(asunto, mensajeCorto);
  }
  
  // Email siempre se env√≠a
  GmailApp.sendEmail(CONFIG.EMAIL, asunto, mensajeEmail);
  Logger.log('üìß Notificaciones enviadas a todas las plataformas activas');
}

function enviarNotificacionError(error) {
  const fecha = new Date().toLocaleString('es-ES', { 
    timeZone: 'Europe/Madrid' 
  });
  
  const mensajeCorto = `‚ùå *Error en Colab Forex*

‚ö†Ô∏è ${error.toString().substring(0, 100)}
üìÖ ${fecha}

üîó Revisar: colab.research.google.com`;
  
  const mensajeEmail = `
Error en ejecuci√≥n autom√°tica

‚ùå Error: ${error.toString()}
üìÖ Fecha: ${fecha}

Por favor, revisa el notebook manualmente:
https://colab.research.google.com/drive/${CONFIG.NOTEBOOK_ID}

---
Automatizaci√≥n via Google Apps Script
  `;
  
  const asunto = '‚ùå Error en ejecuci√≥n autom√°tica de Colab';
  
  // Enviar a todas las plataformas
  if (CONFIG.USAR_TELEGRAM) {
    enviarTelegram(mensajeCorto);
  }
  
  if (CONFIG.USAR_WHATSAPP) {
    enviarWhatsApp(mensajeCorto);
  }
  
  if (CONFIG.USAR_SLACK) {
    enviarSlack(mensajeCorto);
  }
  
  if (CONFIG.USAR_DISCORD) {
    enviarDiscord(mensajeCorto);
  }
  
  if (CONFIG.USAR_PUSHBULLET) {
    enviarPushbullet(asunto, mensajeCorto);
  }
  
  GmailApp.sendEmail(CONFIG.EMAIL, asunto, mensajeEmail);
  Logger.log('üìß Notificaciones de error enviadas');
}

// ============================================================
//   TELEGRAM (‚≠ê RECOMENDADO - Gratis y f√°cil)
// ============================================================

function enviarTelegram(mensaje) {
  try {
    const url = `https://api.telegram.org/bot${CONFIG.TELEGRAM_BOT_TOKEN}/sendMessage`;
    
    const payload = {
      chat_id: CONFIG.TELEGRAM_CHAT_ID,
      text: mensaje,
      parse_mode: 'Markdown'
    };
    
    const options = {
      method: 'post',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };
    
    const response = UrlFetchApp.fetch(url, options);
    const result = JSON.parse(response.getContentText());
    
    if (result.ok) {
      Logger.log('‚úÖ Telegram enviado');
    } else {
      Logger.log('‚ö†Ô∏è Error Telegram: ' + result.description);
    }
  } catch (error) {
    Logger.log('‚ùå Error enviando Telegram: ' + error);
  }
}

// ============================================================
//   WHATSAPP (Via Twilio - requiere cuenta)
// ============================================================

function enviarWhatsApp(mensaje) {
  try {
    const url = `https://api.twilio.com/2010-04-01/Accounts/${CONFIG.TWILIO_ACCOUNT_SID}/Messages.json`;
    
    const payload = {
      From: CONFIG.TWILIO_WHATSAPP_FROM,
      To: CONFIG.TWILIO_WHATSAPP_TO,
      Body: mensaje.replace(/\*/g, '')  // Remover markdown
    };
    
    const options = {
      method: 'post',
      payload: payload,
      headers: {
        'Authorization': 'Basic ' + Utilities.base64Encode(
          CONFIG.TWILIO_ACCOUNT_SID + ':' + CONFIG.TWILIO_AUTH_TOKEN
        )
      },
      muteHttpExceptions: true
    };
    
    const response = UrlFetchApp.fetch(url, options);
    Logger.log('‚úÖ WhatsApp enviado');
  } catch (error) {
    Logger.log('‚ùå Error enviando WhatsApp: ' + error);
  }
}

// ============================================================
//   SLACK
// ============================================================

function enviarSlack(mensaje) {
  try {
    const payload = {
      text: mensaje.replace(/\*/g, '*'),  // Slack usa * para bold tambi√©n
      username: 'Colab Bot',
      icon_emoji: ':robot_face:'
    };
    
    const options = {
      method: 'post',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };
    
    UrlFetchApp.fetch(CONFIG.SLACK_WEBHOOK_URL, options);
    Logger.log('‚úÖ Slack enviado');
  } catch (error) {
    Logger.log('‚ùå Error enviando Slack: ' + error);
  }
}

// ============================================================
//   DISCORD
// ============================================================

function enviarDiscord(mensaje) {
  try {
    const payload = {
      content: mensaje.replace(/\*/g, '**'),  // Discord usa ** para bold
      username: 'Colab Bot'
    };
    
    const options = {
      method: 'post',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };
    
    UrlFetchApp.fetch(CONFIG.DISCORD_WEBHOOK_URL, options);
    Logger.log('‚úÖ Discord enviado');
  } catch (error) {
    Logger.log('‚ùå Error enviando Discord: ' + error);
  }
}

// ============================================================
//   PUSHBULLET (Notificaciones m√≥vil)
// ============================================================

function enviarPushbullet(titulo, mensaje) {
  try {
    const url = 'https://api.pushbullet.com/v2/pushes';
    
    const payload = {
      type: 'note',
      title: titulo,
      body: mensaje.replace(/\*/g, '')
    };
    
    const options = {
      method: 'post',
      contentType: 'application/json',
      headers: {
        'Access-Token': CONFIG.PUSHBULLET_API_KEY
      },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };
    
    UrlFetchApp.fetch(url, options);
    Logger.log('‚úÖ Pushbullet enviado');
  } catch (error) {
    Logger.log('‚ùå Error enviando Pushbullet: ' + error);
  }
}

// ============================================================
//   ‚≠ê INSTALAR TRIGGER (EJECUTA ESTA FUNCI√ìN UNA SOLA VEZ)
// ============================================================

function instalarTriggerDiario() {
  // Eliminar triggers antiguos
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => ScriptApp.deleteTrigger(trigger));
  
  // Crear trigger diario a las 21:00
  ScriptApp.newTrigger('ejecutarNotebookDiario')
    .timeBased()
    .atHour(CONFIG.EXECUTION_HOUR)
    .everyDays(1)
    .create();
  
  Logger.log('‚è∞ Trigger instalado: Se ejecutar√° a las ' + CONFIG.EXECUTION_HOUR + ':00');
  Logger.log('üìÖ D√≠as: Domingo, Lunes, Martes, Mi√©rcoles, Jueves');
  Logger.log('‚úÖ Configuraci√≥n completada');
  
  // Enviar confirmaci√≥n por email
  GmailApp.sendEmail(
    CONFIG.EMAIL,
    '‚úÖ Automatizaci√≥n de Colab configurada',
    `Tu notebook se ejecutar√° autom√°ticamente de domingo a jueves a las ${CONFIG.EXECUTION_HOUR}:00

Notebook ID: ${CONFIG.NOTEBOOK_ID}

Recibir√°s un email cada vez que se ejecute.`
  );
}

// ============================================================
//   FUNCIONES DE UTILIDAD
// ============================================================

function testearEjecucion() {
  Logger.log('üß™ Ejecutando prueba manual...');
  ejecutarNotebookDiario();
}

function desinstalarAutomatizacion() {
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => ScriptApp.deleteTrigger(trigger));
  Logger.log('üõë Automatizaci√≥n desinstalada');
  
  GmailApp.sendEmail(
    CONFIG.EMAIL,
    'üõë Automatizaci√≥n de Colab desactivada',
    'La ejecuci√≥n autom√°tica ha sido desactivada.'
  );
}

function verificarConfiguracion() {
  Logger.log('='.repeat(60));
  Logger.log('CONFIGURACI√ìN ACTUAL');
  Logger.log('='.repeat(60));
  Logger.log('Notebook ID: ' + CONFIG.NOTEBOOK_ID);
  Logger.log('Email: ' + CONFIG.EMAIL);
  Logger.log('Hora de ejecuci√≥n: ' + CONFIG.EXECUTION_HOUR + ':00');
  Logger.log('D√≠as: Domingo a Jueves (Forex)');
  Logger.log('GPU: ' + CONFIG.GPU_TYPE);
  Logger.log('Timeout: ' + CONFIG.MAX_EXECUTION_TIME + ' min');
  Logger.log('='.repeat(60));
  
  try {
    const file = DriveApp.getFileById(CONFIG.NOTEBOOK_ID);
    Logger.log('‚úÖ Acceso al notebook: OK');
    Logger.log('   Nombre: ' + file.getName());
  } catch (error) {
    Logger.log('‚ùå Error accediendo al notebook: ' + error);
  }
}

function verificarDiasEjecucion() {
  const dias = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
  
  Logger.log('='.repeat(60));
  Logger.log('üìÖ D√çAS DE EJECUCI√ìN CONFIGURADOS');
  Logger.log('='.repeat(60));
  
  for (let i = 0; i < 7; i++) {
    const ejecuta = [0, 1, 2, 3, 4].includes(i);
    const icono = ejecuta ? '‚úÖ' : '‚ùå';
    Logger.log(`${icono} ${dias[i]}: ${ejecuta ? 'S√ç ejecuta' : 'NO ejecuta (Forex cerrado)'}`);
  }
  
  Logger.log('='.repeat(60));
  Logger.log(`‚è∞ Hora configurada: ${CONFIG.EXECUTION_HOUR}:00`);
}

// ============================================================
//   üß™ PROBAR MENSAJER√çA
// ============================================================

function probarMensajeria() {
  Logger.log('üß™ Probando todas las plataformas de mensajer√≠a...');
  
  const mensajePrueba = `üß™ *Test de Mensajer√≠a*

Este es un mensaje de prueba.
Si lo recibes, ¬°todo funciona bien!

‚è∞ ${new Date().toLocaleString('es-ES')}`;
  
  Logger.log('Plataformas activas:');
  Logger.log('- Email: Siempre activo');
  if (CONFIG.USAR_TELEGRAM) Logger.log('- Telegram: ‚úÖ');
  if (CONFIG.USAR_WHATSAPP) Logger.log('- WhatsApp: ‚úÖ');
  if (CONFIG.USAR_SLACK) Logger.log('- Slack: ‚úÖ');
  if (CONFIG.USAR_DISCORD) Logger.log('- Discord: ‚úÖ');
  if (CONFIG.USAR_PUSHBULLET) Logger.log('- Pushbullet: ‚úÖ');
  
  // Enviar a todas las plataformas activas
  if (CONFIG.USAR_TELEGRAM) {
    enviarTelegram(mensajePrueba);
  }
  
  if (CONFIG.USAR_WHATSAPP) {
    enviarWhatsApp(mensajePrueba);
  }
  

  if (CONFIG.USAR_SLACK) {
    enviarSlack(mensajePrueba);
  }
  
  if (CONFIG.USAR_DISCORD) {
    enviarDiscord(mensajePrueba);
  }
  
  if (CONFIG.USAR_PUSHBULLET) {
    enviarPushbullet('üß™ Test', mensajePrueba);
  }
  
  // Email de prueba
  GmailApp.sendEmail(
    CONFIG.EMAIL,
    'üß™ Test de mensajer√≠a - Colab Automation',
    mensajePrueba.replace(/\*/g, '')
  );
  
  Logger.log('‚úÖ Mensajes de prueba enviados a todas las plataformas activas');
  Logger.log('Revisa tu email/Telegram/etc para confirmar');
}